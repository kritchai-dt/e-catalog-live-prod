worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nopush    on;
  keepalive_timeout 65;

  # ให้ PHP รู้ว่าเข้าผ่าน HTTPS เมื่ออยู่หลัง proxy ของ Render
  map $http_x_forwarded_proto $fastcgi_https {
    default off;
    https on;
  }

  server {
    # พอร์ตจะถูกแทนค่าจาก env โดย start.sh (envsubst)
    listen       ${PORT};
    server_name  _;

    # โฟลเดอร์รากของโปรเจกต์คุณ
    root   /var/www/html;
    index  index.php index.html;

    # === กฎแก้ลิงก์เดิมตาม .htaccess ===
    # .htaccess เดิม: RewriteRule ^pages/home\.php$ / [R=301,L]
    location = /pages/home.php {
      return 301 /;
    }

    # === เสิร์ฟหน้าเว็บ ===
    # ถ้าเป็นไฟล์/โฟลเดอร์จริงให้เสิร์ฟ ไม่งั้นโยนเข้า index.php
    location / {
      try_files $uri $uri/ /index.php?$query_string;
    }

    # ประมวลผลไฟล์ PHP ผ่าน php-fpm
    location ~ \.php$ {
      include        fastcgi_params;
      fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param  HTTPS $fastcgi_https;
      fastcgi_pass   127.0.0.1:9000;
    }

    # ไฟล์สถิติควร cache ได้
    location ~* \.(css|js|jpg|jpeg|png|gif|svg|ico|woff2?)$ {
      expires 7d;
      access_log off;
      try_files $uri =404;
    }
  }
}